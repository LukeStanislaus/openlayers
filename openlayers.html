<html>

<head>
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.3.1/css/ol.css" type="text/css">
    <style>
        .map {
            height: 800px;
            width: 100%;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.3.1/build/ol.js"></script>
    <title>OpenLayers Modify</title>
</head>

<body>

    <p id="demo">JavaScript can change HTML content.</p>

    <button type="button" onclick='document.getElementById("demo").innerHTML = "Hello JavaScript!"'>Click Me!</button>

    <form id="options-form" automplete="off">
        <div class="radio">
            <label>
                <input type="radio" name="interaction" value="draw" id="draw" checked>
                Draw &nbsp;
            </label>
        </div>
        <div class="radio">
            <label>
                <input type="radio" name="interaction" value="modify" id="modify">
                Modify &nbsp;
            </label>
        </div>
        <div class="form-group">
            <label>Draw type &nbsp;</label>
            <select name="draw-type" id="draw-type">

                <option value="LineString">LineString</option>
                <option value="Point">Point</option>
                <option value="Polygon">Polygon</option>
                <option value="Circle">Circle</option>
            </select>
        </div>
        <div id="map" class="map"></div>
    </form>

    <script>

        //import Feature from 'ol/Feature.js';
        var Feature = ol.Feature;
        //import Map from 'ol/Map.js';
        var Map = ol.Map;
        //import View from 'ol/View.js';
        var View = ol.View;
        //import Point from 'ol/geom/Point.js';
        var Point = ol.geom.Point;

        //import {Tile as TileLayer, Vector as VectorLayer} from 'ol/layer.js';
        var TileLayer = ol.layer.Tile;
        var VectorLayer = ol.layer.Vector;

        //import {Cluster, OSM, Vector as VectorSource} from 'ol/source.js';
        var Cluster = ol.source.Cluster;
        var OSM = ol.source.OSM;
        var VectorSource = ol.source.Vector;

        //="var " & B26 & "= ol.style." & B26 & ";"
        //import {Circle as CircleStyle, Fill, Stroke, Style, Text} from 'ol/style.js';
        var Circle = ol.style.Circle;
        var CircleStyle = ol.style.Circle;
        var Fill = ol.style.Fill;
        var Stroke = ol.style.Stroke;
        var Style = ol.style.Style;
        var Text = ol.style.Text;
        var Icon = ol.style.Icon


        //import {Draw, Modify, Select, Snap} from 'ol/interaction.js';
        var Draw = ol.interaction.Draw;
        var Modify = ol.interaction.Modify;
        var Select = ol.interaction.Select;
        var Snap = ol.interaction.Snap;


        var locations_ArrayOfHardcodedRacingFeatures = [
            [51.659887, -1.932075, "0"],  // Mark : 0
            [51.657782, -1.929267, "1"],  // Mark : 1
            [51.658665, -1.92788, "2"],  // Mark : 2
            [51.659887, -1.927568, "3"],  // Mark : 3
            [51.660719, -1.92771, "4"],  // Mark : 4
            [51.66126, -1.930908, "5"],  // Mark : 5
            [51.66246, -1.933075, "6"],  // Mark : 6
            [51.662223, -1.934958, "7"],  // Mark : 7
            [51.66131, -1.935907, "8"],  // Mark : 8
            [51.659638, -1.933742, "9"],  // Mark : 9
            [51.659233, -1.930221, "Hut"],  // Mark : Hut
            [51.658144, -1.934895, "A"], //Mark : A 
            [51.658112, -1.936521, "B"], //Mark : B
            [51.657318, -1.937959, "C"],//Mark : C
        ];

        var MarkNames = locations_ArrayOfHardcodedRacingFeatures.map(function (val) {
            return val[2];//.slice(2, 0);
        });

        var locations = locations_ArrayOfHardcodedRacingFeatures.map(function (val) {
            return val.slice(0, -1);
        });

        // OpenLayers uses [lon, lat], not [lat, lon]
        locations.map(function (l) {
            return l.reverse();
        });

        var route = new ol.geom.LineString(locations)
            .transform('EPSG:4326', 'EPSG:3857');

        var routeCoords = route.getCoordinates();

        //Create and array containing coordinates name and colour of each mark
        var count = locations_ArrayOfHardcodedRacingFeatures.length;
        var Markfeatures = new Array(count);

        for (var i = 0; i < count; ++i) {
            Markfeatures[i] = new Feature({ geometry: new Point(routeCoords[i]), name: locations_ArrayOfHardcodedRacingFeatures[i][2], markColour: "blue" });
        }

        var MarkSource = new VectorSource({
            features: Markfeatures //features
        });


        let MarkStyle = function (feature) {
            return new Style({
                image: new CircleStyle({
                    radius: 10,
                    stroke: new Stroke({
                        color: '#fff'
                    }),
                    fill: new Fill({
                        color: feature.get("markColour")
                    })
                }),
                text: new Text({
                    text: feature.get("name"),
                    fill: new Fill({
                        color: 'white'
                    })
                })
            });


        }



        let Marks = new VectorLayer({
            source: MarkSource,
            style: MarkStyle,
            id: "Marks"
        });
        //Map Image Layer
        let raster = new TileLayer({
            source: new OSM()
        });



        let styleFunction = function (feature) {
            var geometry = feature.getGeometry();
            var styles = [
                // linestring
                new Style({
                    stroke: new Stroke({
                        color: 'yellow',
                        width: 2
                    })
                })
            ];
            geometry.forEachSegment(function (start, end) {
                var dx = end[0] - start[0];
                var dy = end[1] - start[1];
                var mid = [start[0] + dx * 0.75, start[1] + dy * 0.75];
                var rotation = Math.atan2(dy, dx);
                // arrows
                styles.push(new Style({
                    geometry: new Point(mid),
                    image: new Icon({
                        src: 'https://openlayers.org/en/v3.20.1/examples/data/arrow.png',
                        anchor: [0.75, 0.5],
                        rotateWithView: true,
                        rotation: -rotation
                    })
                }));
            });

            return styles;
        };

        //Course Layer
        var vector = new VectorLayer({
            source: new VectorSource(),
            id: "Course"
        });

        // Render combined image to browser "map" element
        var map = new Map({
            layers: [raster, Marks, vector],
            target: 'map',
            view: new View({
                center: routeCoords[2],//[0, 0],
                zoom: 16
            })
        });


        var ExampleModify = {
            init: function () {
                this.select = new Select();
                map.addInteraction(this.select);

                this.modify = new Modify({
                    features: this.select.getFeatures()
                });
                map.addInteraction(this.modify);

                this.setEvents();
            },
            setEvents: function () {
                var selectedFeatures = this.select.getFeatures();

                this.select.on('change:active', function () {
                    selectedFeatures.forEach(function (each) {
                        selectedFeatures.remove(each);
                    });
                });
            },
            setActive: function (active) {
                this.select.setActive(active);
                this.modify.setActive(active);
            }
        };
        ExampleModify.init();

        ExampleModify.modify.on('modifyend', function (evt) {
            var collection = evt.features;

            collection.forEach(function (feature) {
                feature.setStyle(styleFunction);
            });
        });

        var ExampleDraw = {
            init: function () {
                map.addInteraction(this.Point);
                this.Point.setActive(false);
                map.addInteraction(this.LineString);

                this.LineString.setActive(false);
                map.addInteraction(this.Polygon);
                this.Polygon.setActive(false);
                map.addInteraction(this.Circle);
                this.Circle.setActive(false);
            },
            Point: new Draw({
                source: vector.getSource(),
                type: 'Point'
            }),
            LineString: new Draw({
                source: vector.getSource(),
                type: 'LineString',
            }),
            Polygon: new Draw({
                source: vector.getSource(),
                type: 'Polygon'
            }),
            Circle: new Draw({
                source: vector.getSource(),
                type: 'Circle'
            }),

            getActive: function () {
                return this.activeType ? this[this.activeType].getActive() : false;
            },
            setActive: function (active) {
                var type = optionsForm.elements['draw-type'].value;
                if (active) {
                    this.activeType && this[this.activeType].setActive(false);
                    this[type].setActive(true);
                    this.activeType = type;
                } else {
                    this.activeType && this[this.activeType].setActive(false);
                    this.activeType = null;
                }
            }
        };
        ExampleDraw.init();


        ExampleDraw.LineString.on('drawend', function (evt) {
            var collection = evt.feature.setStyle(styleFunction);

            let routeCoords = evt.feature.getGeometry().getCoordinates().map(
                function (elem) {
                    return map.getPixelFromCoordinate(elem)
                }
            );

            courseTxt = "";
            routeCoords.forEach(ListPortStarboard)

            console.log("Number of points in route :" + routeCoords.length)
            console.log(routeCoords)
            document.getElementById("demo").innerHTML = "Course :" + courseTxt //"Number of points in route :" + routeCoords.length
            ExampleDraw.setActive(false);
            ExampleModify.setActive(true);
            document.getElementById("draw").checked = false;
            document.getElementById("modify").checked = true;
        });

        function ListPortStarboard(value, index, array) {
            let portStarbord = "notSet"
            map.forEachFeatureAtPixel(value, function (feature, layer) {
                if (!layer) {

                    console.log("Not a layer")
                    return
                }

                if (layer.get("id") == "Marks") {
                    console.log(feature.get("markColour"))
                    switch (feature.get("markColour")) {
                        case "blue":
                            portStarbord = "notSet";
                            break;
                        case "green":
                            portStarbord = "s";
                            break;
                        case "red":
                            portStarbord = "p";
                            break;
                        default:
                            break;
                    }
                    console.log(feature.get("name") + portStarbord)
                    courseTxt = courseTxt + " " + feature.get("name") + "(" + portStarbord + ")"
                }
            });

        }
        /***
         * Let user change the geometry type.
         * @param {Event} e Change event.
         */
        var optionsForm = document.getElementById('options-form');
        optionsForm.onchange = function (e) {
            var type = e.target.getAttribute('name');
            var value = e.target.value;
            if (type == 'draw-type') {
                ExampleDraw.getActive() && ExampleDraw.setActive(true);
            } else if (type == 'interaction') {
                if (value == 'modify') {
                    ExampleDraw.setActive(false);
                    ExampleModify.setActive(true);
                } else if (value == 'draw') {
                    ExampleDraw.setActive(true);
                    ExampleModify.setActive(false);
                }
            }
        };

        ExampleDraw.setActive(true);
        ExampleModify.setActive(false);

        // The snap interaction must be added after the Modify and Draw interactions
        var snap = new Snap({ source: MarkSource });
        map.addInteraction(snap);

        // Cycle through colour of marks if a mark happens to have been selected
        map.on('click', function (event) {
            if (document.getElementById("draw").checked) return


            map.forEachFeatureAtPixel(event.pixel, function (feature, layer) {
                if (!feature) return
                selectedFeature = feature;
                if (!layer) return
                let markSelected = false;
                let CourseSelected = false;

                switch (layer.get("id")) {
                    case "Marks":

                        markSelected = true;
                        break;
                    case "Course":
                        CourseSelected = true;
                        let routeCoords = selectedFeature.getGeometry().getCoordinates().map(
                            function (elem) {
                                return map.getPixelFromCoordinate(elem)
                            }
                        );
                        break;
                    default:
                        break;
                }

            });


            if (markSelected = true) {

                switch (selectedFeature.get("markColour")) {
                    case "blue":
                        selectedFeature.set("markColour", "green");
                        break;
                    case "green":
                        selectedFeature.set("markColour", "red");
                        break;
                    case "red":
                        selectedFeature.set("markColour", "blue");
                        break;
                    default:
                        break;
                }
            }

            if (CourseSelected = true) {
                //list course in here?


                //let courseTxt = "";
                routeCoords.forEach(ListPortStarboard)

                console.log("Number of points in route :" + routeCoords.length)
                console.log(routeCoords)
                document.getElementById("demo").innerHTML = "Course :" + courseTxt //"Number of points in route :" + routeCoords.length
                courseTxt = "";
                ExampleDraw.setActive(false);
                ExampleModify.setActive(true);
                document.getElementById("draw").checked = false;
                document.getElementById("modify").checked = true;
            }
        });

    </script>
</body>

</html>