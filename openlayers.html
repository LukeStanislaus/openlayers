<html>

<head>
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.3.1/css/ol.css" type="text/css">
    <style>
        .map {
            height: 800px;
            width: 100%;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.3.1/build/ol.js"></script>
    <title>OpenLayers Modify</title>
</head>

<body>

    <p id="demo">JavaScript can change HTML content.</p>

    <button type="button" onclick='document.getElementById("demo").innerHTML = "Hello JavaScript!"'>Click Me!</button>

    <form id="options-form" automplete="off">
        <div class="radio">
            <label>
                <input type="radio" name="interaction" value="draw" id="draw" checked>
                Draw &nbsp;
            </label>
        </div>
        <div class="radio">
            <label>
                <input type="radio" name="interaction" value="modify" id="modify">
                Modify &nbsp;
            </label>
        </div>
        <div class="form-group">
            <label>Draw type &nbsp;</label>
            <select name="draw-type" id="draw-type">

                <option value="LineString">LineString</option>
                <option value="Point">Point</option>
                <option value="Polygon">Polygon</option>
                <option value="Circle">Circle</option>
            </select>
        </div>
        <div id="map" class="map"></div>
    </form>

    <script>

        //import Feature from 'ol/Feature.js';
        let Feature = ol.Feature;
        //import Map from 'ol/Map.js';
        let Map = ol.Map;
        //import View from 'ol/View.js';
        let View = ol.View;
        //import Point from 'ol/geom/Point.js';
        let Point = ol.geom.Point;

        //import {Tile as TileLayer, Vector as VectorLayer} from 'ol/layer.js';
        let TileLayer = ol.layer.Tile;
        let VectorLayer = ol.layer.Vector;

        //import {Cluster, OSM, Vector as VectorSource} from 'ol/source.js';
        let Cluster = ol.source.Cluster;
        let OSM = ol.source.OSM;
        let VectorSource = ol.source.Vector;

        //="let " & B26 & "= ol.style." & B26 & ";"
        //import {Circle as CircleStyle, Fill, Stroke, Style, Text} from 'ol/style.js';
        let Circle = ol.style.Circle;
        let CircleStyle = ol.style.Circle;
        let Fill = ol.style.Fill;
        let Stroke = ol.style.Stroke;
        let Style = ol.style.Style;
        let Text = ol.style.Text;
        let Icon = ol.style.Icon


        //import {Draw, Modify, Select, Snap} from 'ol/interaction.js';
        let Draw = ol.interaction.Draw;
        let Modify = ol.interaction.Modify;
        let Select = ol.interaction.Select;
        let Snap = ol.interaction.Snap;


        let locations_ArrayOfHardcodedRacingFeatures = [
            [51.659887, -1.932075, "0", true],  // Mark : 0
            [51.657782, -1.929267, "1", true],  // Mark : 1
            [51.658665, -1.92788, "2", true],  // Mark : 2
            [51.659887, -1.927568, "3", true],  // Mark : 3
            [51.660719, -1.92771, "4", true],  // Mark : 4
            [51.66126, -1.930908, "5", true],  // Mark : 5
            [51.66246, -1.933075, "6", true],  // Mark : 6
            [51.662223, -1.934958, "7", true],  // Mark : 7
            [51.66131, -1.935907, "8", true],  // Mark : 8
            [51.659638, -1.933742, "9", true],  // Mark : 9
            
            [51.658144, -1.934895, "A", true], //Mark : A 
            [51.658112, -1.936521, "B", true], //Mark : B
            [51.657318, -1.937959, "C", true],//Mark : C
            [51.659233, -1.930221, "S1", false],  // Mark : Start
            [51.659233, -1.929, "S2", false],  // Mark : Start
            [51.6593, -1.931000, "X", false],//Mark : X
            [51.659, -1.931000, "Y", false],//Mark : X
            [51.6587, -1.931000, "U", false],//Mark : X
        ];

        //let MarkNames = locations_ArrayOfHardcodedRacingFeatures.map(function (val) {
        //    return val[2];//.slice(2, 0);
        // });

        let locations = locations_ArrayOfHardcodedRacingFeatures.map(function (val) {
            return val.slice(0, -2);
        });

        // OpenLayers uses [lon, lat], not [lat, lon]
        locations.map(function (l) {
            return l.reverse();
        });

        let route = new ol.geom.LineString(locations)
            .transform('EPSG:4326', 'EPSG:3857');

        let routeCoords = route.getCoordinates();

        //Create and array containing coordinates name and colour of each mark
        let count = locations_ArrayOfHardcodedRacingFeatures.length;
        let Markfeatures = new Array(count);

        for (let i = 0; i < count; ++i) {
            Markfeatures[i] = new Feature({ geometry: new Point(routeCoords[i]), name: locations_ArrayOfHardcodedRacingFeatures[i][2], markColour: "blue", markFixed: locations_ArrayOfHardcodedRacingFeatures[i][3] }); //, markFixed: locations_ArrayOfHardcodedRacingFeatures[i][3] 
        }

        let MarkSource = new VectorSource({
            features: Markfeatures //features
        });


        let MarkStyle = function (feature) {
            return new Style({
                image: new CircleStyle({
                    radius: 10,
                    stroke: new Stroke({
                        color: '#fff'
                    }),
                    fill: new Fill({
                        color: feature.get("markColour")
                    })
                }),
                text: new Text({
                    text: feature.get("name"),
                    fill: new Fill({
                        color: 'white'
                    })
                })
            });


        }



        let Marks = new VectorLayer({
            source: MarkSource,
            style: MarkStyle,
            id: "Marks"
        });
        //Map Image Layer
        let raster = new TileLayer({
            source: new OSM()
        });



        let styleFunction = function (feature) {
            let geometry = feature.getGeometry();
            let styles = [
                // linestring
                new Style({
                    stroke: new Stroke({
                        color: 'yellow',
                        width: 2
                    })
                })
            ];

            // make sure there are more than one point in geometry
            if (geometry.flatCoordinates.length / 2 == 1) {
                return styles;
            };

            geometry.forEachSegment(function (start, end) {
                let dx = end[0] - start[0];
                let dy = end[1] - start[1];
                let mid = [start[0] + dx * 0.75, start[1] + dy * 0.75];
                let rotation = Math.atan2(dy, dx);
                // arrows
                styles.push(new Style({
                    geometry: new Point(mid),
                    image: new Icon({
                        src: 'https://openlayers.org/en/v3.20.1/examples/data/arrow.png',
                        anchor: [0.75, 0.5],
                        rotateWithView: true,
                        rotation: -rotation
                    })
                }));
            });

            return styles;
        };

        //Course Layer
        let vector = new VectorLayer({
            source: new VectorSource(),
            id: "Course"
        });

        // Render combined image to browser "map" element
        let map = new Map({
            interactions: ol.interaction.defaults({ doubleClickZoom: false }),
            layers: [raster, vector, Marks],
            target: 'map',
            view: new View({
                center: routeCoords[2],//[0, 0],
                zoom: 16
            })
        });


        let ExampleModify = {
            init: function () {
                this.select = new Select({
                    filter: function(feature, layer) {
                        if (feature.get("markFixed") == null) return true
                        else return !feature.get("markFixed")   
                    }
                });
                map.addInteraction(this.select);

                this.modify = new Modify({
                    features: this.select.getFeatures()
                    
                });
                map.addInteraction(this.modify);

                this.setEvents();
            },
            setEvents: function () {
                let features = this.select.getFeatures();

                this.select.on('change:active', function () {
                    features.forEach(function (each) {
                        features.remove(each);
                    });
                });
            },
            setActive: function (active) {
                this.select.setActive(active);
                this.modify.setActive(active);
            }
        };
        ExampleModify.init();

        ExampleModify.modify.on('modifyend', function (evt) {
            let collection = evt.features;

            collection.forEach(function (feature) {
                feature.setStyle(styleFunction);
            });
        });

        let ExampleDraw = {
            init: function () {
                map.addInteraction(this.Point);
                this.Point.setActive(false);
                map.addInteraction(this.LineString);

                this.LineString.setActive(false);
                map.addInteraction(this.Polygon);
                this.Polygon.setActive(false);
                map.addInteraction(this.Circle);
                this.Circle.setActive(false);
            },
            Point: new Draw({
                source: vector.getSource(),
                type: 'Point'
            }),
            LineString: new Draw({
                source: vector.getSource(),
                type: 'LineString',
            }),
            Polygon: new Draw({
                source: vector.getSource(),
                type: 'Polygon'
            }),
            Circle: new Draw({
                source: vector.getSource(),
                type: 'Circle'
            }),

            getActive: function () {
                return this.activeType ? this[this.activeType].getActive() : false;
            },
            setActive: function (active) {
                let type = optionsForm.elements['draw-type'].value;
                if (active) {
                    this.activeType && this[this.activeType].setActive(false);
                    this[type].setActive(true);
                    this.activeType = type;
                } else {
                    this.activeType && this[this.activeType].setActive(false);
                    this.activeType = null;
                }
            }
        };
        ExampleDraw.init();


        ExampleDraw.LineString.on('drawend', function (evt) {
            let collection = evt.feature.setStyle(styleFunction);
            console.log(evt.feature)
            let routeCoordsPixel = evt.feature.getGeometry().getCoordinates().map(
                function (elem) {
                    return map.getPixelFromCoordinate(elem)
                }
            );

            let courseTxt = routeCoordsPixel.reduce(ListPortStarboard, "")

            console.log("Number of points in route :" + routeCoordsPixel.length)
            console.log(routeCoordsPixel)
            document.getElementById("demo").innerHTML = "Course :" + courseTxt //"Number of points in route :" + routeCoords.length
            ExampleDraw.setActive(false);
            ExampleModify.setActive(true);
            document.getElementById("draw").checked = false;
            document.getElementById("modify").checked = true;
        });


        function ListPortStarboard(total, value) {
            let portStarbord = "notSet"
            map.forEachFeatureAtPixel(value, function (feature, layer) {
                if (!layer) {

                    console.log("Not a layer")
                    return
                }

                if (layer.get("id") == "Marks") {
                    console.log(feature.get("markColour"))
                    switch (feature.get("markColour")) {
                        case "blue":
                            portStarbord = "notSet";
                            break;
                        case "green":
                            portStarbord = "s";
                            break;
                        case "red":
                            portStarbord = "p";
                            break;
                        default:
                            break;
                    }
                    // console.log(feature.get("name") + "(" + portStarbord + ")")
                    total = total + " " + feature.get("name") + "(" + portStarbord + ")"
                    return
                }
            });

            return total
        }
        /***
         * Let user change the geometry type.
         * @param {Event} e Change event.
         */
        let optionsForm = document.getElementById('options-form');
        optionsForm.onchange = function (e) {
            let type = e.target.getAttribute('name');
            let value = e.target.value;
            if (type == 'draw-type') {
                ExampleDraw.getActive() && ExampleDraw.setActive(true);
            } else if (type == 'interaction') {
                if (value == 'modify') {
                    ExampleDraw.setActive(false);
                    ExampleModify.setActive(true);
                } else if (value == 'draw') {
                    ExampleDraw.setActive(true);
                    ExampleModify.setActive(false);
                }
            }
        };

        ExampleDraw.setActive(true);
        ExampleModify.setActive(false);

        // The snap interaction must be added after the Modify and Draw interactions
        let snap = new Snap({ source: MarkSource });
        map.addInteraction(snap);

        // Cycle through colour of marks if a mark happens to have been selected
        map.on('click', function (event) {

            if (document.getElementById("draw").checked) return



            map.forEachFeatureAtPixel(event.pixel, function (feature, layer) {
                if (!feature) return
                if (!layer) return

                if (layer.get('id') == "Marks") {
                    switch (feature.get("markColour")) {

                        case "blue":
                            feature.set("markColour", "green");
                            break;
                        case "green":
                            feature.set("markColour", "red");
                            break;
                        case "red":
                            feature.set("markColour", "blue");
                            break;
                        default:
                            break;
                    }
                }
                if (layer.get('id') == "Course") {
                    //list course in here?
                    let geom = feature.getGeometry()
                    let coords = geom.getCoordinates()
                    let routeCoordsPixel = coords.map(
                        elem => map.getPixelFromCoordinate(elem)

                    );
                    let courseTxt = routeCoordsPixel.reduce(ListPortStarboard, "")

                    console.log("Number of points in route :" + routeCoordsPixel.length)
                    console.log(routeCoordsPixel)
                    document.getElementById("demo").innerHTML = "Course :" + courseTxt
                    ExampleDraw.setActive(false);
                    ExampleModify.setActive(true);
                    document.getElementById("draw").checked = false;
                    //document.getElementById("modify").checked = false;
                }


            }, { hitTolerance: 30 });
        });

    </script>
</body>

</html>